name: Validate Security Rules

on:
  push:
    paths:
      - 'rules/sigma/**'
      - 'rules/yara/**'
  pull_request:
    paths:
      - 'rules/sigma/**'
      - 'rules/yara/**'

jobs:
  validate-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Detect changed rules
        id: changed-rules
        run: |
          git diff --name-only HEAD~1 HEAD > changed_files.txt || true
          echo "Changed files:"
          cat changed_files.txt || true
          
          SIGMA_RULES=$(grep -E "^rules/sigma/.*\.(yml|yaml)$" changed_files.txt | tr '\n' ',' || echo "")
          echo "sigma_rules=${SIGMA_RULES}" >> $GITHUB_OUTPUT
          
          YARA_RULES=$(grep -E "^rules/yara/.*\.(yara|yar)$" changed_files.txt | tr '\n' ',' || echo "")
          echo "yara_rules=${YARA_RULES}" >> $GITHUB_OUTPUT
          
          if [ -z "$SIGMA_RULES" ] && [ -z "$YARA_RULES" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "$SIGMA_RULES" ]; then
            echo "Changed Sigma rules: $SIGMA_RULES"
          fi
          if [ -n "$YARA_RULES" ]; then
            echo "Changed YARA rules: $YARA_RULES"
          fi

      - name: Generate synthetic logs from OLD rules
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "STEP 0a: Generating synthetic logs from OLD rules"
          echo "============================================================"
          
          git stash
          git checkout HEAD~1
          
          echo "Checking OLD rule directory..."
          ls -la rules/sigma/ 2>/dev/null || echo "No Sigma rules found"
          
          if [ -d "rules/sigma" ]; then
            python validator/generate_logs.py \
              --rules-dir rules/sigma \
              --output-dir synthetic_logs/baseline \
              --log-count 100
            echo "Generated baseline logs from OLD rules"
          else
            echo "No OLD Sigma rules found, creating empty baseline"
            mkdir -p synthetic_logs/baseline
            touch synthetic_logs/baseline/empty.jsonl
          fi
          
          git checkout -
          git stash pop || true
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Generate synthetic logs from NEW rules
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "STEP 0b: Generating synthetic logs from NEW rules"
          echo "============================================================"
          
          mkdir -p new_rules_temp
          
          IFS=',' read -ra SIGMA_ARRAY <<< "${{ steps.changed-rules.outputs.sigma_rules }}"
          NEW_RULE_COUNT=0
          
          for rule in "${SIGMA_ARRAY[@]}"; do
            rule=$(echo "$rule" | xargs)
            if [ -n "$rule" ] && [ -f "$rule" ]; then
              echo "Copying new Sigma rule: $rule"
              cp "$rule" new_rules_temp/
              NEW_RULE_COUNT=$((NEW_RULE_COUNT + 1))
            fi
          done
          
          IFS=',' read -ra YARA_ARRAY <<< "${{ steps.changed-rules.outputs.yara_rules }}"
          for rule in "${YARA_ARRAY[@]}"; do
            rule=$(echo "$rule" | xargs)
            if [ -n "$rule" ] && [ -f "$rule" ]; then
              echo "Copying new YARA rule: $rule"
              cp "$rule" new_rules_temp/
              NEW_RULE_COUNT=$((NEW_RULE_COUNT + 1))
            fi
          done
          
          echo "Total new rules to test: $NEW_RULE_COUNT"
          
          if [ -n "$(ls -A new_rules_temp 2>/dev/null)" ]; then
            echo "Generating synthetic logs for NEW rules..."
            python validator/generate_logs.py \
              --rules-dir new_rules_temp \
              --output-dir synthetic_logs/new_rules \
              --log-count 50
            echo "Generated logs for NEW rules"
          else
            echo "No new rules to generate logs for"
            mkdir -p synthetic_logs/new_rules
            touch synthetic_logs/new_rules/empty.jsonl
          fi
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Combine synthetic logs
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "STEP 0c: Combining synthetic logs"
          echo "============================================================"
          
          mkdir -p synthetic_logs/combined
          
          BASELINE_LOGS=$(find synthetic_logs/baseline -name "*.jsonl" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
          NEW_LOGS=$(find synthetic_logs/new_rules -name "*.jsonl" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
          
          echo "Baseline logs: $BASELINE_LOGS"
          echo "New rule logs: $NEW_LOGS"
          
          cat synthetic_logs/baseline/*.jsonl > synthetic_logs/combined/all_logs.jsonl 2>/dev/null || touch synthetic_logs/combined/all_logs.jsonl
          cat synthetic_logs/new_rules/*.jsonl >> synthetic_logs/combined/all_logs.jsonl 2>/dev/null || true
          
          TOTAL_LOGS=$(wc -l < synthetic_logs/combined/all_logs.jsonl || echo "0")
          echo "Total combined logs: $TOTAL_LOGS"
          
          if [ "$TOTAL_LOGS" -eq 0 ]; then
            echo "WARNING: No logs generated"
          else
            echo "Successfully combined synthetic logs"
          fi

      - name: Validate OLD rules baseline
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "STEP 1: Validating OLD rules (baseline)"
          echo "============================================================"
          
          git stash
          git checkout HEAD~1
          
          python validator/validate_rules.py \
            --all-sigma-rules rules/sigma \
            --all-yara-rules rules/yara \
            --synthetic-logs-dir synthetic_logs/combined \
            --output-dir validation_results/baseline \
            --mode baseline
          
          echo "Baseline validation complete"
          
          git checkout -
          git stash pop || true
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Validate NEW rules current
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "STEP 2: Validating NEW rules (old + new)"
          echo "============================================================"
          
          python validator/validate_rules.py \
            --all-sigma-rules rules/sigma \
            --all-yara-rules rules/yara \
            --synthetic-logs-dir synthetic_logs/combined \
            --output-dir validation_results/current \
            --mode current
          
          echo "Current validation complete"
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Compare and classify new rules
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "STEP 3: Comparing baseline vs current"
          echo "============================================================"
          
          echo "Checking detection files..."
          echo "Baseline detections:"
          ls -lh validation_results/baseline/detections.json || echo "  Not found"
          echo "Current detections:"
          ls -lh validation_results/current/detections.json || echo "  Not found"
          
          if [ -f "validation_results/current/detections.json" ]; then
            echo "Sample current detections (first 3):"
            head -50 validation_results/current/detections.json
          fi
          
          python validator/compare_and_classify.py \
            --baseline-results validation_results/baseline \
            --current-results validation_results/current \
            --changed-sigma-rules "${{ steps.changed-rules.outputs.sigma_rules }}" \
            --changed-yara-rules "${{ steps.changed-rules.outputs.yara_rules }}" \
            --output-file validation_results/classification_report.json \
            --debug
          
          echo "Classification complete"
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Check validation results and rule quality
        if: steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "STEP 4: Checking validation results"
          echo "============================================================"
          
          python validator/check_results.py \
            --results-dir validation_results \
            --classification-report validation_results/classification_report.json \
            --fail-on-bad-rules true

      - name: Generate summary report
        if: always() && steps.changed-rules.outputs.has_changes == 'true'
        run: |
          echo "============================================================"
          echo "Generating summary report"
          echo "============================================================"
          
          if [ -f "validation_results/classification_report.json" ]; then
            python validator/generate_report.py \
              --classification-report validation_results/classification_report.json \
              --output-file validation_results/SUMMARY.md
            echo "Report generated"
          else
            echo "Classification report not found, creating minimal summary"
            mkdir -p validation_results
            cat > validation_results/SUMMARY.md << 'EOFMARKER'
          # Validation Summary
          
          **Status:** Incomplete
          
          The validation process did not complete successfully. Please check the workflow logs for errors.
          
          ## Possible Issues:
          - No rules were changed
          - Error in synthetic log generation
          - Error in rule validation
          - Error in comparison/classification
          
          Please review the GitHub Actions logs for detailed error messages.
          EOFMARKER
            echo "Created minimal summary report"
          fi
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Upload validation artifacts
        if: always() && steps.changed-rules.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: |
            validation_results/**
            synthetic_logs/**
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && steps.changed-rules.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summaryPath = 'validation_results/SUMMARY.md';
            if (fs.existsSync(summaryPath)) {
              const summary = fs.readFileSync(summaryPath, 'utf8');
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }


